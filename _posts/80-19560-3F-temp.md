---
layout:     post
title:      WLAN Host Feature       
subtitle:   Host    
date:       2023-07-24
author:     BuBu
header-img: img/green-background.jpg
catalog: true
tags:
    - WLAN Driver   
  
---

----------
### 1.Acronyms

ATF: Airtime fairness   
RTF: ranging and round trip time  
LOWI: Location WLAN Interface   
MBSSID: multiple BSSID  
EMA AP: Enhanced multi-BSSID advertisement AP  
DCS: Dynamic Channel Selection  
OBSS: Overlapping BSS  
OBSS PD SR: OBSS packet detect spatial reuse  
TWT: Target Wake Time   
OCE: Optimized Connectivity Experience    
MBO: Multband Operation  
A-MPDU: aggregate medium access control (MAC) protocol data unit  
CSI: channel state information  

non-spatial reuse group (non-SRG): An adjective indicating the quality of not being a member of a particular spatial reuse group or the quality of not originating from a station (STA) that is a member of a basic service set (BSS) that is part of a particular spatial reuse group.  



----------

### 2.RTT 

Location WLAN Interface (LOWI) that provides APIs for ranging and round trip time (RTT 11mc).  

	LOWI_HELIUM_RANGING_INTERFACE
	RTT_MSG_SUBTYPE_CAPABILITY_REQ
	RTT_MSG_SUBTYPE_MEASUREMENT_REQ
	RTT_MSG_SUBTYPE_CONFIGURE_LCI
	RTT_MSG_SUBTYPE_CONFIGURE_LCR
 

### 3.ATF 

Use TX token to assign TX time.  

	struct wlan_lmac_if_atf_tx_ops {
		void (*ic_atf_update_node_txtoken)();
		u_int8_t (*ic_atf_tokens_used)();	
	}

### 4.Scan API  

	ucfg_scan_start()  
	ucfg_scan_register_event_handler()
	Scan module public API will post a message (SCAN_MGR_GET_RESULTS_MSG) to get the scan result.  

### 5.MBSSID capabilities 

Multiple BSSID or mBSSID is an AP feature that enables creation of multiple virtual Access Points using a single physical radio.   
This will allow configuration of multiple infrastructure networks, each IS with different BSSID and different access characteristics like security mode and access control configurations.  

6 GHz AP that supports Multi BSSID and advertising partial list of non-Tx BSSID profiles is required to be an Enhanced Multi-BSSID Advertisement (EMA AP).  

### 6.6GHz

As of April 2020, FCC opened up 1.2 GHz of unlicensed spectrum for Wi-Fi use. This will be identified under 'Wi-Fi 6E' for certification.   

**CSA**: An AP and its connected stations (if applicable) must be able to switch between 5GHz and 6GHz bands seamlessly without reassociation.  
**DFS**: Enable random channel selection policy within and across bands. Additionally, ensure that Agile DFS is aware of both bands of operation.  
**Security**: Ensure seamless channel switching across the 5GHz and 6GHz bands only if operating security mode is identical.   
**MBSSID**: Ensure the multi-VAP radios (also known as Multi-BSSID or MBSSID) are seamlessly transitioned to the new band.  
**Security**: 6GHz band supports only Open and WPA3 modes.   

### 7.OBSS_PD spatial reuse 

Refer to `26.10.2 OBSS PD-based spatial reuse operation` 

The OBSS_PD spatial reuse functionality is supported. To increase user data, APs are being set up with reduced cell size. However, the de-sense area of the STA is large due to requirement to defer at minimum sensitivity.   
In dense environments, packets from OBSS AP/STA that are weak, may prevent AP/STA in BSS for transmission. A 6-bit random code in the preamble enables the BSS PHY to quickly recognize the OBSS reception. When signal is weak enough, the BSS AP/STA will transmit over it without disturbing communication in both BSS and OBSS.   

If OBSS_PD is enabled with valid threshold (in the range -82 dBm to -62 dBm), then monitor VAP does not capture packets below the threshold. 

`The HE-SIG-A field for an HE SU PPDU or an HE ER SU PPDU contains the fields listed in Table 27-18.   B8–B13 BSS Color 6 An identifier of the BSS.`    
`WMI_PDEV_PARAM_SET_CMD_OBSS_PD_THRESHOLD`

### 8.Max BSS idle time support
The Max Idle Period field of the BSS Max Idle Period element indicates the time period during which a STA can refrain from transmitting frames to its associated AP without being disassociated. 

### 9.Off-channel Tx and Rx  

Off-channel Tx feature enables sending frames on a different channel than the current operating channel. This functionality uses scan mechanism to go to foreign channel and then sends the frame.   
This section describes the lower-level details of APIs and functions provided to achieve this capability. This section helps in understanding the changes related to off-channel Tx on the Host software codebase. This section describes the functionality/services provided by off-channel Tx.    

### 10.Ring Operation

	htt_h2t_rx_ring_cfg() //config ring in host to adapte different chip 
	enum hal_ring_type { }
	enum hal_srng_ring_id { }

### 11.LMAC ID in data path

REO rings are not PDEV specific, so no remapping operation is required. Buffer replenish is performed by queuing to the appropriate refill LMAC ring, so it is important to select the lmac ID while accessing the refill ring after a mode switch. This is handled automatically because of the way rx buffers are initialized. Since the rx refill ring is moved to soc domain and is accessed via lmac id, the rx descriptor pool is now also associated with the same lmac id. A call to `dp_pdev_rx_buffers_attach` ties the refill ring to the descriptor pool.In dp_rx_pdev_attach(…)

In receive path: `dp_rx_process()`   

- Rx descriptor is derived from cookie.  
- Pool id derived from `rx_desc` is the `lmac_id` used during init. So the `"rx_bufs_reaped"` count indicates buffers reaped from appropriate hardware lmac.  
- During replenish, `mac_id` corresponds to the lmac whose buffers were reaped.    

In Transmit path: 
The lmac_id stored in pdev is being used to setup lmac_id in TCL descriptor, which will be updated by cdp_soc_map_pdev_to_lmac API during mode switch. Also, in the HTT layer of the transit path, target PDEV ID must be obtained from host PDEV ID.


#### 12.IEEE 802.11 standard features 

#### 12.1.802.11n(high throughput) features  

 A-MPDU  
 A-MSDU

##### 12.1.1.A-MPDU aggregation (peer feature negotiation)

The 802.11n specification defines the protocol for negotiating A-MPDU aggregation parameters with a peer. This negotiation is bi-directional; that is, each peer has to agree to receive A-MPDU aggregates. Each peer that wants to transmit A-MPDUs sends a request to the other side to establish resources for receiving aggregates. If the other side accepts the request, it will respond with a positive acknowledgment, and specify the resources it has available for receiving an aggregate. A-MPDU aggregation is implemented as a sliding window, called a **Block ACK Window (BAW)**, over a sequence number set. Each peer specifies the number of buffers it has available for reordering packets. This number cannot be exceeded by the sender. **Note that aggregation is negotiated independently for each TID being used between a pair of peers.** The capability exchange and negotiation is termed **“ADDBA exchange”**.
After the negotiation is completed successfully, the sender can send aggregate MDPUs (A-MPDUs) to the receiver.  

> An A-MPDU consists of a sequence of one or more A-MPDU subframes and a variable amount of EOF padding as shown in Figure 9-741.  
> Figure 9-741—A-MPDU format  
> Figure 9-743—A-MPDU subframe format  
> Figure 12-16—Expanded CCMP MPDU
> medium access control (MAC) frame: The unit of data exchanged between MAC entities. Syn: medium access control (MAC) protocol data unit (MPDU).  
> Figure 9-1—MAC frame format  

`ADDBA_REQUEST` ``  
Refer to `9.7 Aggregate MPDU (A-MPDU)`, An A-MPDU consists of a sequence of one or more A-MPDU subframes and a variable amount of EOF padding as shown in Figure 9-741.  
MLME-ADDBA frame exchange, refer to `Figure 10-32—Message sequence chart for block ack mechanism: (a) setup, (b) data and acknowledgment transfer, and (c) teardown` 

<font color="#FF8C00">Message sequence chart for block ack mechanism:  </font>  
<img src="/img/post/2023-07-31-block-ack-mechanism.png"/>  

##### 12.1.2.A-MSDU aggregation  

A-MSDU aggregation is another way of aggregating packets. **The sender packages multiple Ethernet packets into a single wireless packet and queues** it for transmission. When the receiver gets this packet, each component packet is extracted and handed up to the protocol stack. A-MSDU aggregate reception is mandated by the 802.11n standard for the normal ACK policy and is negotiated when using A-MPDU (Block ACK). Transmission of A-MSDUs is optional. The 
presence of an A-MSDU aggregate is indicated by the AMSDU bit in the QoS header. **A-MSDU size is restricted to a maximum of either 3839 or 7935 bytes, and the value to be used is provided in the HT-Capabilities IE**. The Qualcomm driver restricts it to 3839 bytes for receive. Note that A-MSDUs can be aggregated into A-MPDUs

Each packet (sub-frame) that is aggregated into an A-MSDU has the following format: DA, SA, and length, followed by an LLC header. Each sub-frame is rounded up to be a multiple of four bytes (with a padding of 0-3 bytes). Note that any padding is not reflected in the packet length field in the sub-frame header.   
Refer to `Figure 9-54—A-MSDU structure` and `Figure 9-55—Basic A-MSDU subframe structure`. Subframe include DA and SA.  

#### 12.2.802.11ac (very high throughput) features 

VHT features supported on QCA9880 based products include all mandatory and some optional features defined in the IEEE P802.11ac/D3.1 specification.   
 5 GHz support  
 VHT AP and STA connectivity  
 20/40/80 MHz channel width  
 MCS 0-9  
 1, 2 and 3 Spatial streams  
 Short Guard Interval  
 TX and RX STBC  
 VHT A-MPDU delimiter for RX/TX for Single MPDU  
 A-MPDU RX/TX, Max AMPDU length (3895, 7991, or 11454 bytes)  
 A-MSDU RX/TX  
 CCA on secondary  
 Static and Dynamic Bandwidth Signaling  
 Bandwidth Signaling using RTS and CTS  


#### 12.3.802.11ax (highly effective) features 

 Increased spectral frequency reuse and manage interference between OBSS (**Adaptive CCA** (MAC))  
 Support of outdoor WLAN operation (stationary or pedestrian speeds) (4x longer orthogonal frequency division multiplexing (OFDM))  
 4x throughput improvement in a dense environment (**DL/UL OFDMA, DL/UL MU-MIMO**)  

The bands of operation are 2.4 GHz and 5 GHz. The salient features of 802.11ax are as follows:  
 DL OFDMA  
 UL OFDMA  
 UL MU-MIMO  
 Outdoor channel support (4x symbol duration)  
 Adaptive CCA  
 1024-QAM (may be proprietary, not necessarily 11ax)  
 MCS0 repetition 2 (also called 11ah MCS10) may be included  

##### 12.3.1.MU-MIMO

11ax introduced DL MU-MIMO. Up to 4 users are spatially multiplexed. 11ax increases DL MU-MIMO to 8 users spatially multiplexed. 11ax also introduces UL MU-MIMO. Up to 8 users are spatially multiplexed. MU-MIMO on top of OFDMA allows communication to more users at the same time.   

<font color="#FF8C00">11ac/11ax DL MU-MIMO :  </font>  
<img src="/img/post/2023-07-31-11ac-11ax-DL-MU-MIMO.png"/>   
 
<font color="#FF8C00">11ax UL MU-MIMO :  </font>   
<img src="/img/post/2023-07-31-11ax-UL-MU-MIMO.png"/>   

AP transmits a trigger frame soliciting the transmission of UL MU PPDU from multiple STAs. STAs transmit UL MU (OFDMA or MU-MIMO) PPDU as immediate response to the trigger frame. AP transmits acknowledgment frame in response to UL MU PPDU. Trigger frame is needed for:  
 Time synchronization among MU STAs based on the end of the trigger PPDU  
 Frequency offset correction based on the common AP reference from the trigger  
 Providing duration and PPDU length of UL transmission  
 Providing ID information of the STAs that are allowed to transmit, inclusive of spatial streams/tone allocation  
 Providing power control information  

**UL MU PPDU**  
 UL PPDU can be multiplexed using OFDMA or MU- MIMO.  
 IFS between the Trigger frame and UL MU PPDUs is SIFS.  

##### 12.3.2.11AX OFDMA  

11ax OFDMA resource units:  
 RU sizes: 26 / 52 / 106/ 242 / 484 tones  
 26-tone RU is about 2MHz wide  
 Narrowband transmission has longer range  
 May use different size RUs in the same PPDU  
 Max RUs: 9 (20MHz), 18 (40MHz), 37 (80MHz), 74 (160MHz)  

<font color="#FF8C00">40MHz BSS RU example :  </font>    
<img src="/img/post/2023-07-31-40MHz-BSS-Resource-unit.png"/>    

##### 12.3.3.UL OFDMA  

- AP sends trigger frame by contending with AC_BE.    
- Trigger frame is transmitted by MCS 0, duplicated format in every 20 MHz channels (assuming 74-bytes long).    
- STAs are allocated using trigger frame send data frames. MCS, transmission sub-band, and maximum frame length of data frame are addressed in the trigger frame. If the station does not have any queued data frame, it does not send anything. If the station does not have enough data frame to fill maximum frame length, it adds padding bits to data frame.
- STAs do not perform CCA.  
- AP sends each BA frame in same sub-band with its data frame. BA frame is transmitted by MCS 0.  
- Contending of STAs is not permitted  

<font color="#FF8C00">UL OFDMA :  </font>    
<img src="/img/post/2023-07-31-UL-OFDMA.png"/>    

##### 12.3.4.DL OFDMA  

 AP sends data frame by contending with AC_BE  
 If AP does not have enough data frame for four stations, some sub-bands can be empty and wasted  
 The STA in head of AP’s queue must be selected as primary destination  
 Frame length is determined by primary destination  
 Padding bits can be used in secondary destinations  
 STA sends each BA frame in same sub-band with its data frame  
 BA frame is transmitted by MCS 0  

<font color="#FF8C00">DL OFDMA :  </font>    
<img src="/img/post/2023-07-31-DL-OFDMA.png"/>   

##### 12.3.5.Adaptive CCA  

Clear Channel Assessment (CCA) is fixed in current IEEE amendments. **However, theoretically, it is better to adapt CCA, for each BSS, to an optimum level that depends on the locations of the STA vs the AP, and neighboring BSS/OBSS.** For instance, in this BSS, the STAs backoff if they receive a frame from any node within their coverage.   
However, based on the location of the nodes in this BSS, they can adopt a CCA > -82dBm until the AP receives all the STAs that are above the new CCA or until the STAs defer to each other based on the new CCA value (preferably). Adapting the CCA level should consider potential STAs nearby. In below, adopting a CCA>-82dBm by either of BSS is less likely to hurt the operation of the other BSS significantly.   

<font color="#FF8C00">Adaptive CCA example:  </font>    
<img src="/img/post/2023-07-31-Adaptive-CCA.png"/>    

##### 12.3.6.Longer symbol  

GI：0.4us, 0.8us, 1.6us, 3.2us   
OFDM symbol is information carried by all subcarriers in one the FFT interval. In an OFDM symbol sequence, the k:th OFDM symbol (in complex low-pass equivalent form) is as follows:  
<font color="#FF8C00">11ax longer symbol:  </font>    
<img src="/img/post/2023-07-31-11ax-longer-symbol.png"/> 

##### 12.3.7.Longer IDFT/DFT length
  
PHY structure in frequency: 4-times larger FFT than 11ac. Subcarrier spacing (SC) is 78.125kHz : 4-times more tones in frequency.  
PHY structure in time: 4-times longer IDFT/DFT period than 11ac. IDFT/DFT length is 12.8μs: 4-times longer length in time. Two CPs: Cyclic prefix (CP) is {1.6μs or 3.2μs}, short CP is {0.4μs or 0.8μs}.  

<font color="#FF8C00">11ax longer DFT length:  </font>    
<img src="/img/post/2023-07-31-11ax-Longer-DFT-length.png"/>   

#### 13.Transmit beamforming (TxBF)  

**beamformee**: A station (STA) that **receives** a physical layer (PHY) protocol data unit (PPDU) that was transmitted using a beamforming steering matrix.  
**beamformer**: A station (STA) that **transmits** a physical layer (PHY) protocol data unit (PPDU) using a beamforming steering matrix.  
**beamforming**: A spatial filtering mechanism used at a transmitter to improve the received signal power or signal-to-noise ratio (SNR) at an intended receiver. Syn: beam steering.   

This section describes the software for Transmit Beamforming (TxBF). It includes an introduction and a software flow.   
To calculate an appropriate steering matrix for transmit spatial processing when transmitting to a specific beamformee, the beamformer needs to have an accurate estimate of the channel that it is transmitting over. **There are two methods for BF: implicit feedback and explicit feedback.** Only explicit feedback is supported.  

**Explicit feedback TxBF**  
**When using explicit feedback, the beamformee makes a direct estimate of the channel from training symbols sent to the beamformee by the beamformer. The beamformee may prepare Channel State Information or Steering feedback (compressed or non compressed) based on an observation of these training symbols. The beamformee quantizes the feedback and sends it to the beamformer. The beamformer can use the feedback as the basis for determining transmit steering vectors.**    

<font color="#FF8C00">Explicit feedback TxBF:  </font>    
<img src="/img/post/2023-07-31-Explicit-feedback-TxBF.png"/>  
 
<font color="#FF8C00">Software flow for explicit TxBF:  </font>    
<img src="/img/post/2023-07-31-Software-flow-for-explicit-TxBF.png"/> 

**Sounding PPDU:**    
Sounding PPDUs are transmitted by STAs to enable the receiving STAs to estimate the channel between the transmitting STA and the receiving STA. The sounding PPDU should be set to 0 (Not Sounding) in the HT-SIG field. Send the proper extension HT_LTF for training BF.

**Beamforming software flow**  
The software flow for BF can be divided into the following: initialization, after new association, Tx rate adaption, Tx descriptor setting, Tx descriptor status handling, Rx descriptor handling, Rx frame parsing, and CV update mechanism.  